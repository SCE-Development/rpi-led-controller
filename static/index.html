<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SCE LED Sign</title>
  </head>

  <body>
    <input type="datetime-local" id="endTime" name="endTime" />
    <!--
        - change the below to a button
        - add a window.getElementById(...).addEventListener(...)
        - prevent the form from being submitted, it should be in your click handler that a fetch is made
        - the click handler does the conversion of timezones, etc. before submitting
      -->
    <button class="button" id="submit-button">Submit End Time</button>
    <h3 id="isOff" style="display: none">Sign is Off</h3>
    <marquee
      id="sign-preview"
      direction="left"
      style="
        width: 150px;
        border-style: solid;
        border-width: 5px;
        font-family: monospace;
        font-size: 20px;
      "
    />

    <script>
      // if you have a date variable (or create a new date), this gives you the utc value
      // new Date().toISOString()

      // what we should do here is
      // - get the date that the user entered (console log it to see if its in milpitas timezone)
      // - once you have this user inputted value as a variable, use toISOString to convert it to a UTC string
      // - pass the UTC string to the backend
      document.getElementById("submit-button").addEventListener("click", click);

      function click() {
        var currTime = new Date(document.getElementById("endTime").value);

        location.href = new URL(
          "api/update-sign?endTime=" + currTime.toISOString().slice(0, 16),
          window.location.origin
        ).href;
      }
      // restricts minimum date entered
      const localDate = new Date().toLocaleString();
      var localISO = new Date(localDate);
      localISO = new Date(
        localISO.getTime() - localISO.getTimezoneOffset() * 60000
      )
        .toISOString()
        .slice(0, 16);
      document.getElementById("endTime").min = localISO;

      //updates sign
      const handleFetch = async () => {
        url = new URL("api/health-check", window.location.origin);
        try {
          const res = await fetch(url.href);
          if (!res.ok) {
            throw new Error("Could not fetch resource");
          }

          const data = await res.json();

          if (!Object.hasOwn(data, "text")) {
            document.getElementById("sign-preview").style.display = "none";

            document.getElementById("isOff").style.display = "block";
            return;
          }
          document.getElementById("sign-preview").style.color = data.textColor;
          document.getElementById("sign-preview").style.backgroundColor =
            data.backgroundColor;
          document.getElementById("sign-preview").style.borderColor =
            data.borderColor;
          document.getElementById("sign-preview").innerHTML = data.text;
          document
            .getElementById("sign-preview")
            .setAttribute("scrollamount", data.scrollSpeed);
        } catch (err) {
          console.log(err);
        }
      };
      handleFetch();
    </script>
  </body>
</html>
